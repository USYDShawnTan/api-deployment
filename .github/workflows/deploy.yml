name: Deploy to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_message:
        description: "éƒ¨ç½²è¯´æ˜"
        required: false
        default: "æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Deployment Repository
        uses: actions/checkout@v4
        with:
          path: deployment

      - name: Checkout Frontend Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.FRONTEND_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          path: frontend
          fetch-depth: 1

      - name: Checkout Backend Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.BACKEND_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          path: backend
          fetch-depth: 1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Prepare Project Structure
        run: |
          # åˆ›å»ºç®€å•çš„éƒ¨ç½²ç»“æ„
          mkdir -p deploy-package/api
          mkdir -p deploy-package/frontend

          # å¤åˆ¶æ ¸å¿ƒ API æ–‡ä»¶
          cp deployment/index.py deploy-package/api/
          touch deploy-package/api/__init__.py

          # ç¡®ä¿ app ç›®å½•å­˜åœ¨
          if [ -d "backend/app" ]; then
            cp -r backend/app deploy-package/
          else
            mkdir -p deploy-package/app
            touch deploy-package/app/__init__.py
          fi

          # å¤„ç† requirements.txt
          cp backend/requirements.txt deploy-package/

          # ç¡®ä¿ requirements.txt åŒ…å« mangum ä¾èµ–
          if ! grep -q "mangum" deploy-package/requirements.txt; then
            echo "mangum>=0.17.0" >> deploy-package/requirements.txt
          fi

          # æ‰“å° requirements.txt å†…å®¹ä»¥éªŒè¯
          echo "Requirements.txt å†…å®¹:"
          cat deploy-package/requirements.txt

          # å¤åˆ¶å‰ç«¯æ–‡ä»¶
          cp -r frontend/* deploy-package/frontend/

          # å¤åˆ¶ Vercel é…ç½®
          cp deployment/vercel.json deploy-package/

          # æ˜¾ç¤ºéƒ¨ç½²ç»“æ„
          echo "éƒ¨ç½²åŒ…ç»“æ„:"
          find deploy-package -type f | grep -v "node_modules" | sort

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel
        id: deploy
        run: |
          cd deploy-package

          # åˆ›å»º Vercel é¡¹ç›®é…ç½®
          mkdir -p .vercel
          echo "{\"orgId\":\"${{ secrets.VERCEL_ORG_ID }}\",\"projectId\":\"${{ secrets.VERCEL_PROJECT_ID }}\"}" > .vercel/project.json

          # éƒ¨ç½²åˆ° Vercel
          vercel deploy --prod --token "${{ secrets.VERCEL_TOKEN }}" --confirm \
            -e API_ACCESS_PASSWORD="${{ secrets.API_ACCESS_PASSWORD }}" \
            -e NODE_ENV="production" \
            -e MONGODB_URI="${{ secrets.MONGODB_URI }}" \
            -e MONGODB_DB_NAME="${{ secrets.MONGODB_DB_NAME }}" \
            -e REACT_APP_API_URL="${{ secrets.REACT_APP_API_URL }}"

          echo "status=$?" >> $GITHUB_OUTPUT

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸ $(date)"
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"ğŸš€ éƒ¨ç½²æˆåŠŸ: $(date)\"}" \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"
          fi

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ $(date)"
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"âŒ éƒ¨ç½²å¤±è´¥: $(date)\"}" \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"
          fi
