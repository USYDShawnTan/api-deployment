name: Deploy to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_message:
        description: "éƒ¨ç½²è¯´æ˜"
        required: false
        default: "æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Deployment Repository
        uses: actions/checkout@v4
        with:
          path: deployment

      - name: Checkout Frontend Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.FRONTEND_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          path: frontend
          fetch-depth: 1

      - name: Checkout Backend Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.BACKEND_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          path: backend
          fetch-depth: 1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Prepare Project Structure
        run: |
          # åˆ›å»ºåŸºæœ¬éƒ¨ç½²ç»“æ„
          mkdir -p deploy-package/api
          mkdir -p deploy-package/frontend
          
          # æŸ¥çœ‹åç«¯ç»“æ„
          echo "åç«¯ä»“åº“ç»“æ„:"
          find backend -type f | grep -v "__pycache__" | sort
          
          # å¤åˆ¶FastAPIå…¥å£æ–‡ä»¶åˆ°APIç›®å½•
          cp deployment/index.py deploy-package/api/
          touch deploy-package/api/__init__.py
          
          # å¤åˆ¶åç«¯æ–‡ä»¶ - æ›´å…¨é¢åœ°å¤åˆ¶æ‰€æœ‰å¿…è¦æ–‡ä»¶
          # 1. å¤åˆ¶æ•´ä¸ªappç›®å½•åŠå…¶æ‰€æœ‰å†…å®¹åˆ°æ ¹ç›®å½•å’ŒAPIç›®å½•
          if [ -d "backend/app" ]; then
            echo "å¤åˆ¶åç«¯appç›®å½•..."
            cp -r backend/app deploy-package/
            
            # ç¡®ä¿APIå¯ä»¥ç›´æ¥è®¿é—®appæ¨¡å—
            cp -r backend/app/* deploy-package/api/ 2>/dev/null || true
            
            # åˆ›å»ºç¬¦å·é“¾æ¥ä»¥ç¡®ä¿å¯¼å…¥è·¯å¾„æ­£ç¡®
            cd deploy-package
            for dir in $(find app -type d); do
              mkdir -p api/$dir
            done
            cd ..
          else
            echo "è­¦å‘Š: åç«¯appç›®å½•ä¸å­˜åœ¨!"
            mkdir -p deploy-package/app
            touch deploy-package/app/__init__.py
          fi
          
          # 2. å¤åˆ¶å…¶ä»–å…³é”®åç«¯æ–‡ä»¶
          if [ -f "backend/run.py" ]; then
            cp backend/run.py deploy-package/
          fi
          
          if [ -f "backend/.env" ]; then
            cp backend/.env deploy-package/
          fi
          
          # 3. ä¼˜åŒ–requirements.txt - åªä¿ç•™å¿…è¦ä¾èµ–
          cat > deploy-package/requirements.txt << EOL
fastapi==0.103.1
uvicorn==0.23.2
motor==3.2.0
python-dotenv==1.0.0
pydantic==2.3.0
starlette==0.27.0
EOL
          
          # å¤åˆ¶å‰ç«¯æ–‡ä»¶
          cp -r frontend/* deploy-package/frontend/
          
          # å¤åˆ¶Vercelé…ç½®
          cp deployment/vercel.json deploy-package/
          
          # åœ¨APIç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªç®€å•çš„requirements.txtæŒ‡å‘ä¸»è¦çš„requirements.txt
          echo "-r ../requirements.txt" > deploy-package/api/requirements.txt
          
          # æ˜¾ç¤ºéƒ¨ç½²åŒ…çš„å®Œæ•´ç»“æ„
          echo "=== æœ€ç»ˆéƒ¨ç½²åŒ…ç»“æ„ ==="
          find deploy-package -type f -o -type d | grep -v "node_modules" | sort
          
          # æ˜¾ç¤ºAPIç›®å½•å†…å®¹
          echo "=== APIç›®å½•å†…å®¹ ==="
          find deploy-package/api -type f | sort
          
          # æ˜¾ç¤ºrequirements.txtå†…å®¹
          echo "=== Requirements.txtå†…å®¹ ==="
          cat deploy-package/requirements.txt

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel
        id: deploy
        run: |
          cd deploy-package

          # åˆ›å»º Vercel é¡¹ç›®é…ç½®
          mkdir -p .vercel
          echo "{\"orgId\":\"${{ secrets.VERCEL_ORG_ID }}\",\"projectId\":\"${{ secrets.VERCEL_PROJECT_ID }}\"}" > .vercel/project.json

          # éªŒè¯ vercel.json é…ç½®æ–‡ä»¶æ ¼å¼
          cat vercel.json
          echo "æ­£åœ¨éªŒè¯ vercel.json..."

          # æ£€æŸ¥ vercel.json é…ç½®æ˜¯å¦æœ‰æ•ˆ
          if ! jq empty vercel.json 2>/dev/null; then
            echo "é”™è¯¯: vercel.json ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼"
            exit 1
          fi

          # éƒ¨ç½²åˆ° Vercel
          echo "å¼€å§‹éƒ¨ç½²åˆ°Vercel..."
          vercel deploy --prod --token "${{ secrets.VERCEL_TOKEN }}" --yes \
            -e API_ACCESS_PASSWORD="${{ secrets.API_ACCESS_PASSWORD }}" \
            -e NODE_ENV="production" \
            -e MONGODB_URI="${{ secrets.MONGODB_URI }}" \
            -e MONGODB_DB_NAME="${{ secrets.MONGODB_DB_NAME }}" \
            -e REACT_APP_API_URL="${{ secrets.REACT_APP_API_URL }}" \
            -e PYTHONPATH="/var/task:/var/task/api"

          DEPLOY_EXIT_CODE=$?
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "Vercel éƒ¨ç½²å¤±è´¥ï¼Œé€€å‡ºç : $DEPLOY_EXIT_CODE"
            echo "æŸ¥çœ‹ Vercel éƒ¨ç½²æ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯"
            exit $DEPLOY_EXIT_CODE
          fi
          
          echo "âœ… Verceléƒ¨ç½²æˆåŠŸå®Œæˆ"
          echo "status=$DEPLOY_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸ $(date)"
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"ğŸš€ éƒ¨ç½²æˆåŠŸ: $(date)\"}" \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"
          fi

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ $(date)"
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"âŒ éƒ¨ç½²å¤±è´¥: $(date)\"}" \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"
          fi
